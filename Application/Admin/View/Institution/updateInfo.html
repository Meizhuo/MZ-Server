<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>机构用户管理</title>


    <script type="text/javascript" src="/mz/Public/js/sidebar.js"></script>
    <link href="/mz/Public/css/zw_a.css" rel="stylesheet" type="text/css" />
    <link href="/mz/Public/css/cat_fb.css" rel="stylesheet" type="text/css" />
    <link href="/mz/Public/css/ins_wd.css" rel="stylesheet" type="text/css" />

</head>

<body>
    <div id="logo">
        <a href="{:U('admin/institution/index')}">
            <img src="/mz/Public/images/zw_w.png" width="80px" height="55px">
        </a>
    </div>

    <div id="parent_a">
        <div id="PARENT">
            <ul id="nav">
                <li><a href="{:U('admin/institution/updateInfo')}" onclick="DoMenu('ChildMenu1')">登记信息</a>

                </li>
                <li><a href="{:U('admin/institution/postCourse')}" onClick="DoMenu('ChildMenu2')">发布课程</a>

                </li>
                <li><a href="{:U('admin/institution/courseList')}" onClick="DoMenu('ChildMenu3')">课程列表</a>

                </li>

            </ul>
        </div>

    </div>



    <div id="topbar">
        <span>欢迎 {$institution['nickname']}</span>
        <input id="btn-logout" type="submit" value="退出登录" style="float:right;height: 30px;font-size: 16px;">
    </div>

    <!--下面只是说明与程序代码无关-->
    <div id="include" style=" width:80%;height:auto; display:block; margin:0 auto;  font-size:10pt; line-height:150%; ">
        <div class="ht">
            <h1>登记信息</h1>
        </div>
        <div id="cat_wr">
            <table style="width:100%; border:0">
                <tr>
                    <td width="80">
                        <div class="mz-text-center">
                            审核状态</div>
                    </td>
                    <td width="400">
                        <p style="height:100%;width:100%;padding-left: 4px;">
                            <if condition="$institution['status'] eq 0">待审核
                                <elseif condition="$institution['status'] eq 1" />审核已通过
                                <else />审核不通过
                            </if>

                        </p>
                    </td>
                </tr>
                <tr>
                    <td width="80">
                        <div class="mz-text-center">
                            <span>*</span>机构名称</div>
                    </td>
                    <td width="400">
                        <input id="text-name" class="inp" type="text" style="height:100%;width:100%;" value="{$institution['name']}" placeholder="必填">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">机构地址</div>
                    </td>
                    <td>
                        <input id="text-address" class="inp" type="text" style="height:100%;width:100%;" value="{$institution['address']}">
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class="mz-text-center">机构负责人</div>
                    </td>
                    <td>
                        <input id="text-manager" type="text" class="inp" style="height:100%;width:100%;" value="{$institution['manager']}">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">办学类型</div>
                    </td>
                    <td>
                        <input id="text-type" class="inp" type="text" style="height:100%;width:100%;" value="{$institution['type']}">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">批准文号</div>
                    </td>
                    <td>
                        <input id="text-approval_number" class="inp" type="text" style="height:100%;width:100%;" value="{$institution['approval_number']}">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">有效时间</div>
                    </td>
                    <td>
                        <input id="text-validity_date" class="inp" type="text" style="height:100%;width:100%;" value="{$institution['validity_date']}" placeholder=" 格式：年-月-日 如 2014-10-1">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">培训范围</div>
                    </td>
                    <td>
                        <input id="text-training_scope" class="inp" type="text" style="height:100%;width:100%;" value="{$institution['training_scope']}">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">师资力量</div>
                    </td>
                    <td>
                        <input id="text-teacher_resource" type="text" class="inp" style="height:100%;width:100%;" value="{$institution['teacher_resource']}">
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class="mz-text-center">
                            <span>*</span>联系人</div>
                    </td>
                    <td>
                        <input id="text-contact_member" type="text" class="inp" style="height:100%;width:100%;" value="{$institution['contact_member']}" placeholder="必填">
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class="mz-text-center">
                            <span>*</span>联系电话</div>
                    </td>
                    <td>
                        <input id="text-contact_phone" type="text" class="inp" style="height:100%;width:100%;" value="{$institution['contact_phone']}" placeholder="必填">
                    </td>
                </tr>

                <tr>
                    <td>
                        <div class="mz-text-center">联系邮箱</div>
                    </td>
                    <td>
                        <input id="text-contact_email" type="text" class="inp" style="height:100%;width:100%;" value="{$institution['contact_email']}">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">描述</div>
                    </td>

                    <td height="400">
                        <script id="editor" type="text/plain" style="height:100%"></script>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="mz-text-center">
                            <span>*</span>附件</div>
                    </td>

                    <td>
                        <div id="drag-and-drop-zone" class="uploader">
                            <input style="width:150px;" type="file" name="image2">
                            <span>
                                <strong style="color:red;">*</strong>
                                <strong>文件最大为4MB,只能上传1文件,建议上传用zip压缩打包,支持zip,doc,docx,jpg,png,gif</strong>
                                <!-- <strong id="progress"></strong> -->
                            </span>
                            <br>
                            <div id="fileList">
                                <foreach name="institution.files" item="file">
                                    <div>
                                        <span>{$file['raw_name']} 已上传</span><a href="javascript:void(0);" style="margin-left: 10px;" name="btn-delete" data-id="{$file['id']}">删除</a>
                                        <br>
                                    </div>
                                </foreach>
                            </div>

                        </div>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <input id="btn-submit" class="submit" value="发布" type="submit">
                    </td>
                </tr>
            </table>
        </div>
    </div>

</body>
<!-- UEditor START-->
<script type="text/javascript" charset="utf-8" src="/mz/Public/js/ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="/mz/Public/js/ueditor/ueditor.all.min.js">
</script>
<script type="text/javascript" charset="utf-8" src="/mz/Public/js/ueditor/lang/zh-cn/zh-cn.js"></script>
<!-- UEditor end-->

<script type="text/javascript">
var initContent = '{$institution["description"]}';

//实例化编辑器
//建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
var ue = UE.getEditor('editor', {
    toolbars: [
        ['fullscreen', 'undo', 'redo', 'bold']
    ],
    autoHeightEnabled: true,
    autoFloatEnabled: true,
    enableAutoSave: false,
    saveInterval: 2000000000,
    enableContextMenu: false, //打开右键菜单功能
    initialContent: initContent, //初始化编辑器的内容
    initialFrameWidth: 910,
});

ue.ready(function() {
    ue.setContent(initContent);
});
</script>

<script type="text/javascript" src="/mz/Public/js/jquery.min.js"></script>
<script type="text/javascript" src="/mz/Public/js/dmuploader.js"></script>
<script type="text/javascript">
(function($) {
    var uid = "{$uid}";
    var ins_id = "{$uid}";
    var file_ids = {};
    if ('{$file_ids}' !== '' && '{$file_ids}' !=='null' ) {
        file_ids = JSON.parse('{$file_ids}'); //附件 init..
    }

    //更新文档附件
    function updateDocFiles() {
        console.log('updateDocFilesByIns');
        console.log({
            ins_id: ins_id,
            // file_ids: JSON.stringify(file_ids),
            file_ids: file_ids,
        });
        $.post("{:U('home/document/updateDocFilesByIns','','')}", {
            ins_id: ins_id,
            file_ids: file_ids,
        }, function(json) {
            console.log("upload file result::");
            console.log(json);
            if (json.code) {
                alert('操作成功');
                setTimeout(function() {
                    location = "{:U('admin/institution/manage')}";
                }, 500);

            } else {
                console.log(json);
                alert(json.msg);
            }
        });
    }


    //退出
    $('#btn-logout').on('click', function() {
        $.get('/mz/index.php/home/user/logout', function(data) {
            // console.log(data);
            if (data.code) {
                location = '/mz/ins/';
            } else {
                console.log(data.msg);
            }
        });
    });


    function insert(src, key, val) {
        if (val !== '') {
            src[key] = val;
        }
    }

    //更新用户信息
    $('#btn-submit').on('click', function() {
        console.log("click");

        var name = $('#text-name').val();
        var address = $('#text-address').val();
        var manager = $('#text-manager').val();
        var type = $('#text-type').val();
        var approval_number = $('#text-approval_number').val();
        var validity_date = $('#text-validity_date').val();
        var training_scope = $('#text-training_scope').val();
        var teacher_resource = $('#text-teacher_resource').val();
        var contact_member = $('#text-contact_member').val();
        var contact_phone = $('#text-contact_phone').val();
        var contact_email = $('#text-contact_email').val();
        var description = UE.getEditor('editor').getContent();


        if (name === '') {
            alert('机构名称不能为空');
            return;
        }

        if (contact_member === '') {
            alert('联系人不能为空');
            return;
        }
        if (contact_phone === '') {
            alert('联系电话不能为空');
            return;
        }

        var post_data = {};
        insert(post_data, 'uid', uid);
        insert(post_data, 'name', name);
        insert(post_data, 'address', address);
        insert(post_data, 'manager', manager);
        insert(post_data, 'type', type);
        insert(post_data, 'approval_number', approval_number);
        insert(post_data, 'validity_date', validity_date);
        insert(post_data, 'training_scope', training_scope);
        insert(post_data, 'teacher_resource', teacher_resource);
        insert(post_data, 'contact_member', contact_member);
        insert(post_data, 'contact_phone', contact_phone);
        insert(post_data, 'contact_email', contact_email);
        insert(post_data, 'description', description);

        $.post("{:U('home/institution/update')}", post_data, function(json) {
            if (json.code) {
                // alert('更新成功！');
                updateDocFiles();
                // setTimeout(function() {
                //     location = "{:U('admin/institution/manage')}";
                // }, 1000);
            } else {
                alert(json.msg);
            }
        }).fail(function(err) {
            console.log(err);
        });
    });

    //删除一条上传的条目
    $('#fileList').on('click', '[name=btn-delete]', function() {
        var $ele = $(this);
        var file_id = $ele.data('id');
        $.post("{:U('home/document/deleteFile','','')}", {
            file_id: file_id,
        }, function(json) {
            //fuck here
            if (json.code) {
                $ele.parent().html('');
                delete file_ids[file_id];
                location = location;
            } else {
                // json
                alert('删除失败');
            }
        });
    });



    function add_log(message) {
        console.log(message);
    }

    function add_file(file_name, file_id) {
        var template = '<div><span>{file_name}  已上传</span><a href="javascript:void(0);" style="margin-left: 10px;" name="btn-delete" data-id="{file_id}">删除</a><br></div>';

        if (file_name && file_id) {
            $('#fileList').prepend(template.replace('{file_name}', file_name).replace('{file_id}', file_id));
        }

    }


    //上传
    // Upload Plugin itself
    $('#drag-and-drop-zone').dmUploader({
        url: "{:U('home/document/upload')}",
        dataType: 'json',
        // allowedTypes: '*',
        /*extFilter: 'jpg;png;gif',*/
        onInit: function() {
            add_log('Penguin initialized :)');
        },
        onBeforeUpload: function(id) {
            add_log('Starting the upload of #' + id);

        },

        onComplete: function() {
            add_log('All pending tranfers finished');
        },
        onUploadProgress: function(id, percent) {
            var percentStr = percent + '%';
            // $('#progress').text('上传进度: ' + percentStr);
        },
        //上传文件成功
        onUploadSuccess: function(id, data) {
            add_log('Upload of file #' + id + ' completed');

            add_log('Server Response for file #' + id + ': ' + JSON.stringify(data));
            if (data.code) {
                add_file(add_file(data.response.raw_name, data.response.id));
                file_ids[data.response.id] = data.response.id;
            } else {
                alert(data.msg);
            }
        },
        onUploadError: function(id, message) {
            add_log('Failed to Upload file #' + id + ': ' + message);

        },
        onFileTypeError: function(file) {
            add_log('File \'' + file.name + '\' cannot be added: must be an image');

        },
        onFileSizeError: function(file) {
            add_log('File \'' + file.name + '\' cannot be added: size excess limit');
        },
        onFileExtError: function(file) {
            // $.danidemo.addLog('#demo-debug', 'error', 'File \'' + file.name + '\' has a Not Allowed Extension');
        },
        onFallbackMode: function(message) {
            alert('Browser not supported(do something else here!): ' + message);
        }
    });


})(jQuery);
</script>

</html>
